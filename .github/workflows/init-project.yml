name: Initialize Frontida Project

on:
  workflow_dispatch:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  init-project:
    # Only run if issue title contains "Initial .NET 10 Project Setup" or manually triggered
    if: github.event_name == 'workflow_dispatch' || contains(github.event.issue.title, 'Initial .NET 10 Project Setup')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Check if project already exists
        id: check-project
        run: |
          if [ -f "Frontida/Frontida.csproj" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create .NET MVC Project
        if: steps.check-project.outputs.exists == 'false'
        run: |
          # Create the MVC project
          dotnet new mvc -n Frontida -o Frontida
          
          # Navigate to project directory
          cd Frontida
          
          # Add necessary NuGet packages
          dotnet add package Microsoft.EntityFrameworkCore.SqlServer
          dotnet add package Microsoft.EntityFrameworkCore.Tools
          dotnet add package Microsoft.EntityFrameworkCore.Design
          dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
          dotnet add package Microsoft.AspNetCore.Identity.UI

      - name: Create folder structure
        if: steps.check-project.outputs.exists == 'false'
        run: |
          cd Frontida
          
          # Create additional folders
          mkdir -p Data/Migrations
          mkdir -p Models/Domain
          mkdir -p Models/ViewModels
          mkdir -p Models/DTOs
          mkdir -p Services/Interfaces
          mkdir -p Services/Implementations
          mkdir -p Repositories/Interfaces
          mkdir -p Repositories/Implementations

      - name: Create .gitignore
        if: steps.check-project.outputs.exists == 'false'
        run: |
          cat > .gitignore << 'EOF'
          ## Ignore Visual Studio temporary files, build results, and
          ## files generated by popular Visual Studio add-ons.
          
          # User-specific files
          *.rsuser
          *.suo
          *.user
          *.userosscache
          *.sln.docstates
          
          # Build results
          [Dd]ebug/
          [Dd]ebugPublic/
          [Rr]elease/
          [Rr]eleases/
          x64/
          x86/
          [Ww][Ii][Nn]32/
          [Aa][Rr][Mm]/
          [Aa][Rr][Mm]64/
          bld/
          [Bb]in/
          [Oo]bj/
          [Ll]og/
          [Ll]ogs/
          
          # Visual Studio cache/options
          .vs/
          
          # Visual Studio Code
          .vscode/
          
          # ReSharper
          _ReSharper*/
          *.[Rr]e[Ss]harper
          *.DotSettings.user
          
          # NuGet Packages
          *.nupkg
          *.snupkg
          **/packages/*
          !**/packages/build/
          
          # SQL Server files
          *.mdf
          *.ldf
          *.ndf
          
          # Files built by Visual Studio
          *_i.c
          *_p.c
          *_h.h
          *.ilk
          *.meta
          *.obj
          *.iobj
          *.pch
          *.pdb
          *.ipdb
          *.pgc
          *.pgd
          *.rsp
          *.sbr
          *.tlb
          *.tli
          *.tlh
          *.tmp
          *.tmp_proj
          *_wpftmp.csproj
          *.log
          *.tlog
          *.vspscc
          *.vssscc
          .builds
          *.pidb
          *.svclog
          *.scc
          
          # OS generated files
          .DS_Store
          .DS_Store?
          ._*
          .Spotlight-V100
          .Trashes
          ehthumbs.db
          Thumbs.db
          
          # User-specific files
          appsettings.Development.json
          appsettings.Production.json
          EOF

      - name: Create appsettings.json
        if: steps.check-project.outputs.exists == 'false'
        run: |
          cat > Frontida/appsettings.json << 'EOF'
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost;Database=FrontidaDB;Trusted_Connection=True;TrustServerCertificate=True;"
            },
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            },
            "AllowedHosts": "*"
          }
          EOF

      - name: Create appsettings.Development.json template
        if: steps.check-project.outputs.exists == 'false'
        run: |
          cat > Frontida/appsettings.Development.json.example << 'EOF'
          {
            "ConnectionStrings": {
              "DefaultConnection": "Server=localhost;Database=FrontidaDB;Trusted_Connection=True;TrustServerCertificate=True;"
            },
            "Logging": {
              "LogLevel": {
                "Default": "Information",
                "Microsoft": "Information",
                "Microsoft.AspNetCore": "Warning"
              }
            }
          }
          EOF

      - name: Build project
        if: steps.check-project.outputs.exists == 'false'
        run: |
          cd Frontida
          dotnet build

      - name: Create Pull Request
        if: steps.check-project.outputs.exists == 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Initial .NET 10 MVC project setup for Frontida'
          title: 'ðŸš€ Initial .NET 10 Project Setup (Issue #1)'
          body: |
            ## Initial Project Setup
            
            This PR implements **Issue #1: Initial .NET 10 Project Setup**
            
            ### Changes Made:
            - âœ… Created .NET 10 MVC project
            - âœ… Added Entity Framework Core packages
            - âœ… Added ASP.NET Core Identity packages
            - âœ… Created proper folder structure:
              - Controllers/
              - Models/ (Domain, ViewModels, DTOs)
              - Data/Migrations
              - Services/ (Interfaces, Implementations)
              - Repositories/ (Interfaces, Implementations)
              - Views/
              - wwwroot/
            - âœ… Created .gitignore for .NET projects
            - âœ… Created appsettings.json with connection string
            - âœ… Project builds successfully
            
            ### Next Steps:
            After merging this PR, you can:
            1. Clone the repository
            2. Update the connection string in appsettings.json
            3. Run `dotnet ef migrations add InitialCreate`
            4. Run `dotnet ef database update`
            5. Run `dotnet run`
            
            ### Package References:
            - Microsoft.EntityFrameworkCore.SqlServer
            - Microsoft.EntityFrameworkCore.Tools
            - Microsoft.EntityFrameworkCore.Design
            - Microsoft.AspNetCore.Identity.EntityFrameworkCore
            - Microsoft.AspNetCore.Identity.UI
            
            Closes #1
          branch: feature/initial-project-setup
          delete-branch: true

      - name: Comment on Issue
        if: steps.check-project.outputs.exists == 'false' && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ **Project initialization started!**\n\nA pull request has been created with the initial .NET 10 MVC project setup. Please review and merge the PR to get started with development.\n\n**Next steps after merging:**\n1. Clone the repository\n2. Update connection string in `appsettings.json`\n3. Run migrations\n4. Start coding!\n\n_Automated by Frontida Init Workflow_'
            });

      - name: Project Already Exists
        if: steps.check-project.outputs.exists == 'true'
        run: |
          echo "Project already exists. Skipping initialization."
          
      - name: Comment Project Exists
        if: steps.check-project.outputs.exists == 'true' && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â„¹ï¸ The Frontida project already exists in this repository. No initialization needed.'
            });
